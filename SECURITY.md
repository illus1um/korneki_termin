# Безопасность и устойчивость бота

## Реализованные меры безопасности

### 1. Валидация входных данных
- ✅ Валидация длины поисковых запросов (макс 200 символов)
- ✅ Санитизация пользовательского ввода
- ✅ Валидация callback_data для предотвращения инъекций
- ✅ Валидация ID категорий и подкатегорий
- ✅ Проверка параметров админ-команд

### 2. Rate Limiting
- ✅ Ограничение частоты запросов (20 запросов/минуту для обычных пользователей)
- ✅ Увеличенный лимит для админов (100 запросов/минуту)
- ✅ Автоматическая очистка старых запросов

### 3. Защита от Path Traversal
- ✅ Валидация всех путей к файлам в админке
- ✅ Проверка, что файлы находятся в разрешённых директориях
- ✅ Безопасный экспорт и создание бэкапов

### 4. Обработка ошибок
- ✅ Глобальный обработчик ошибок (ErrorHandlerMiddleware)
- ✅ Обработка ошибок Telegram API (BadRequest, NetworkError, etc.)
- ✅ Graceful degradation при ошибках
- ✅ Логирование всех ошибок

### 5. Логирование
- ✅ Структурированное логирование в файлы
- ✅ Ротация логов (10 MB, 5 файлов)
- ✅ Отдельный файл для ошибок
- ✅ Логирование попыток несанкционированного доступа

### 6. Защита админки
- ✅ Проверка прав доступа через декоратор
- ✅ Логирование всех попыток доступа
- ✅ Валидация всех параметров админ-команд

## Устойчивость

### 1. Обработка длинных сообщений
- ✅ Автоматическое разбиение при превышении лимита Telegram (4096 символов)
- ✅ Fallback на отправку нового сообщения при ошибке edit_text

### 2. Обработка сетевых ошибок
- ✅ Retry механизм для критических операций
- ✅ Graceful handling TelegramNetworkError
- ✅ Обработка TelegramRetryAfter

### 3. Валидация данных
- ✅ Валидация данных при загрузке CSV
- ✅ Обработка ошибок парсинга
- ✅ Защита от некорректных данных

### 4. Логирование ошибок
- ✅ Все ошибки логируются с полным traceback
- ✅ Критические ошибки уведомляют админов (в будущем)

## Настройки безопасности

Настройки можно изменить в `.env`:

```env
# Rate limiting
RATE_LIMIT_DEFAULT=20      # Лимит для обычных пользователей
RATE_LIMIT_PERIOD=60       # Период в секундах
RATE_LIMIT_ADMIN=100       # Лимит для админов

# Валидация
MAX_QUERY_LENGTH=200       # Максимальная длина поискового запроса

# Логирование
LOG_LEVEL=INFO             # Уровень логирования
LOG_DIR=logs               # Директория для логов
```

## Мониторинг

Все события логируются в:
- `logs/bot.log` - общий лог
- `logs/bot_errors.log` - только ошибки

Логи ротируются автоматически при достижении 10 MB.

## Рекомендации

1. Регулярно проверяйте логи на наличие подозрительной активности
2. Мониторьте попытки несанкционированного доступа к админке
3. Следите за rate limiting - частые превышения могут указывать на атаку
4. Регулярно обновляйте зависимости для исправления уязвимостей

